---
import { siteConfig } from "@/site.config";

interface Props {
  slot: string;
  format?:
    | "auto"
    | "fluid"
    | "autorelaxed"
    | "vertical"
    | "rectangle"
    | "horizontal";
  layoutKey?: string;
  layout?: string;
  class?: string;
  style?: string;
  fullWidthResponsive?: boolean;
}

const {
  slot,
  format = "auto",
  layoutKey,
  layout,
  class: className,
  style = "display: block; max-width: 100%;",
  fullWidthResponsive,
} = Astro.props;

const id = `ad-${crypto.randomUUID()}`;
---

{
  siteConfig.adsense.enabled && (
    <div
      id={id}
      class={`w-full max-w-full flex justify-center items-center relative bg-secondary/50 rounded-xl overflow-hidden transition-colors duration-200 ${className || ""}`}
    >
      {/* Placeholder text */}
      <span class="absolute inset-0 flex items-center justify-center text-muted-foreground/50 text-sm font-medium pointer-events-none ad-placeholder py-8">
        Advertisement
      </span>
      <ins
        class="adsbygoogle relative z-10 w-full"
        style={style}
        data-ad-client={siteConfig.adsense.clientId}
        data-ad-slot={slot}
        data-ad-format={format}
        data-ad-layout-key={layoutKey}
        data-ad-layout={layout}
        data-full-width-responsive={fullWidthResponsive}
      />
      <script is:inline define:vars={{id}}>
        const pushAd = (retries = 0) => {
          if (retries > 3) return;
          
          const el = document.getElementById(id);
          if (!el) return;

          // Strict visibility check
          const rect = el.getBoundingClientRect();
          const style = window.getComputedStyle(el);

          if (rect.width > 0 && rect.height > 0 && style.display !== 'none' && style.visibility !== 'hidden') {
            try {
              (adsbygoogle = window.adsbygoogle || []).push({});
            } catch (e) {
              if (e.message && e.message.includes('No slot size')) {
                 // Component hidden or too small, skipping push (expected for responsive ads)
                 return; 
              }
              console.warn("AdSense push failed, retrying...", e);
              setTimeout(() => pushAd(retries + 1), 2000);
            }
          } else {
             // Element not visible yet, wait a bit
             setTimeout(() => pushAd(retries), 500);
          }
        };

        // Initial push with slight delay
        setTimeout(() => pushAd(), 200);

        // Listen for 403 errors on the ad slot specifically (if possible via capturing network interactions, 
        // essentially just relying on global window error handling or the catch block above)
        window.addEventListener('error', (e) => {
          if (e.message && (e.message.includes('403') || e.message.includes('adsbygoogle'))) {
             // Retry if feasible, though 403 usually implies domain mismatch or auth
             // For localhost, 403 is expected, but we will retry gracefully just in case it's a transient network issue
             // Logic is handled in the pushAd catch block mostly.
          }
        });
      </script>
    </div>
  )
}

<style>
  /* Hide placeholder when ad loads */
  .adsbygoogle[data-ad-status="filled"] ~ .ad-placeholder,
  .adsbygoogle:not(:empty) ~ .ad-placeholder {
    display: none;
  }
</style>
